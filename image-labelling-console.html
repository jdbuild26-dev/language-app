<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Labelling Data Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .marker {
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .marker:hover {
            transform: translate(-50%, -50%) scale(1.2);
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="glass sticky top-0 z-50 border-b border-slate-200 px-6 py-4 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="bg-indigo-600 p-2 rounded-lg text-white">
                <i data-lucide="layout"></i>
            </div>
            <div>
                <h1 class="font-bold text-slate-900 leading-none">LabelConsole</h1>
                <p class="text-xs text-slate-500 mt-1">Image Labelling Data Generator</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <button onclick="exportToCSV()"
                class="flex items-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-all shadow-lg shadow-emerald-200">
                <i data-lucide="download" class="w-4 h-4"></i>
                Export CSV
            </button>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden">

        <!-- Sidebar: Configuration -->
        <aside class="w-80 border-r border-slate-200 bg-white flex flex-col">
            <div class="p-6 space-y-8 overflow-y-auto custom-scrollbar flex-1">

                <!-- Cloudinary Settings -->
                <section>
                    <div class="flex items-center gap-2 mb-4">
                        <i data-lucide="cloud" class="w-4 h-4 text-indigo-500"></i>
                        <h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest">Cloudinary Setup</h2>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1">Cloud Name</label>
                            <input type="text" id="cloudName" value="danch6kwx" placeholder="e.g. dxyz123"
                                class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1">API Key</label>
                            <input type="text" id="apiKey" value="291621314183126" placeholder="API Key"
                                class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1">API Secret</label>
                            <input type="password" id="apiSecret" value="R1Npp_VGjtPB9TXrSpxYUZoq9yY"
                                placeholder="API Secret"
                                class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                        </div>
                        <div class="pt-2 border-t border-slate-100">
                            <label class="block text-[10px] font-bold text-slate-400 mb-1 uppercase italic">OR USE
                                UNSIGNED PRESET</label>
                            <input type="text" id="uploadPreset" placeholder="Unsigned Preset Name"
                                class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition-all uppercase placeholder:normal-case">
                        </div>
                    </div>
                </section>

                <!-- Label Management -->
                <section>
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <i data-lucide="list" class="w-4 h-4 text-indigo-500"></i>
                            <h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest">Labels</h2>
                        </div>
                        <span id="labelCount"
                            class="text-[10px] bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded-full font-bold">0</span>
                    </div>

                    <div class="flex gap-2 mb-4">
                        <input type="text" id="newLabelInput" placeholder="Add label..."
                            class="flex-1 px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none focus:border-indigo-500">
                        <button onclick="addLabel()"
                            class="bg-slate-900 text-white p-2 rounded-lg hover:bg-slate-800 transition-all">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                        </button>
                    </div>

                    <div id="labelList" class="space-y-2">
                        <!-- Labels will appear here -->
                        <p class="text-center py-8 text-slate-400 text-xs italic">No labels added yet</p>
                    </div>
                </section>

                <!-- Selected Marker Settings -->
                <section id="markerSettings" class="hidden">
                    <div class="bg-indigo-50 border border-indigo-100 rounded-xl p-4">
                        <h3 class="text-xs font-bold text-indigo-600 uppercase tracking-widest mb-3">Selected Marker
                        </h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-[10px] font-bold text-indigo-400 mb-1">LABEL NAME</label>
                                <p id="editLabelName" class="text-sm font-semibold text-slate-700"></p>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-[10px] font-bold text-indigo-400 mb-1">X (%)</label>
                                    <input type="number" id="editLabelX"
                                        class="w-full px-2 py-1 bg-white border border-indigo-200 rounded text-xs">
                                </div>
                                <div>
                                    <label class="block text-[10px] font-bold text-indigo-400 mb-1">Y (%)</label>
                                    <input type="number" id="editLabelY"
                                        class="w-full px-2 py-1 bg-white border border-indigo-200 rounded text-xs">
                                </div>
                            </div>
                            <button onclick="deleteMarker()"
                                class="w-full mt-2 text-[10px] font-bold text-red-500 hover:text-red-600 py-1 transition-all">
                                REMOVE MARKER
                            </button>
                        </div>
                    </div>
                </section>
            </div>
        </aside>

        <!-- Workspace -->
        <div class="flex-1 bg-slate-100 p-8 flex flex-col items-center justify-start overflow-y-auto custom-scrollbar">

            <!-- Upload Dropzone -->
            <div id="dropzone"
                class="w-full max-w-2xl aspect-video border-4 border-dashed border-slate-300 rounded-3xl flex flex-col items-center justify-center bg-white shadow-xl transition-all cursor-pointer hover:border-indigo-400 group relative overflow-hidden">
                <div class="animate-bounce mb-4 text-slate-400 group-hover:text-indigo-500 transition-all">
                    <i data-lucide="upload-cloud" class="w-16 h-16"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-700">Drop an image here</h3>
                <p class="text-slate-400 text-sm mt-2">or click to pick a file / Paste (Ctrl+V)</p>
                <input type="file" id="fileInput" class="hidden" accept="image/*">

                <div id="uploadStatus"
                    class="hidden absolute inset-0 bg-white/80 backdrop-blur-sm flex flex-col items-center justify-center z-20">
                    <div class="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin">
                    </div>
                    <p class="mt-4 font-bold text-indigo-600">Uploading to Cloudinary...</p>
                </div>
            </div>

            <!-- Image Canvas -->
            <div id="canvasContainer"
                class="hidden max-w-full bg-white rounded-3xl shadow-2xl overflow-hidden relative border-8 border-white">
                <div class="relative inline-block mx-auto" id="imageWrapper">
                    <img id="previewImage"
                        class="max-w-full max-h-[80vh] block select-none cursor-crosshair object-contain">
                    <div id="markersLayer" class="absolute inset-0 pointer-events-none"></div>
                </div>
                <div
                    class="absolute top-4 left-4 glass px-3 py-1.5 rounded-full border border-slate-200 text-xs font-semibold text-slate-600 pointer-events-none">
                    Click anywhere on the image to place the active label
                </div>
            </div>

            <div id="imageInfo" class="hidden mt-6 flex flex-wrap justify-center gap-6">
                <div class="bg-white px-4 py-2 rounded-xl shadow-sm border border-slate-200 flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-indigo-100 flex items-center justify-center text-indigo-600">
                        <i data-lucide="image" class="w-4 h-4"></i>
                    </div>
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase">Image URL</p>
                        <p id="cloudinaryUrlDisplay"
                            class="text-xs font-medium text-slate-700 truncate max-w-[200px] lg:max-w-[400px]">
                            ...</p>
                    </div>
                </div>
                <button onclick="copyMockData()"
                    class="flex items-center gap-2 bg-slate-900 text-white px-4 py-2 rounded-xl text-xs font-bold transition-all shadow-lg hover:bg-slate-800 uppercase">
                    <i data-lucide="copy" class="w-4 h-4"></i>
                    Copy Mock Data
                </button>
                <button onclick="changeImage()"
                    class="flex items-center gap-2 text-xs font-bold text-slate-400 hover:text-slate-600 transition-all uppercase px-4 border border-slate-200 rounded-xl hover:bg-white">
                    Change Image
                </button>
            </div>

        </div>

    </main>

    <script>
        // --- State Management ---
        let labels = []; // { id, name }
        let activeLabelId = null;
        let selectedMarker = null; // { index }
        let imageUrl = '';
        let markers = []; // { name, x, y } (x, y are 0.0 to 1.0)

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            setupEventListeners();
        });

        function setupEventListeners() {
            const dropzone = document.getElementById('dropzone');
            const fileInput = document.getElementById('fileInput');

            dropzone.onclick = () => fileInput.click();
            fileInput.onchange = (e) => handleFiles(e.target.files);

            // Drag & Drop
            dropzone.ondragover = (e) => { e.preventDefault(); dropzone.classList.add('border-indigo-400', 'bg-indigo-50'); };
            dropzone.ondragleave = () => { dropzone.classList.remove('border-indigo-400', 'bg-indigo-50'); };
            dropzone.ondrop = (e) => {
                e.preventDefault();
                dropzone.classList.remove('border-indigo-400', 'bg-indigo-50');
                handleFiles(e.dataTransfer.files);
            };

            // Paste
            window.onpaste = (e) => {
                const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                for (let index in items) {
                    const item = items[index];
                    if (item.kind === 'file') {
                        handleFiles([item.getAsFile()]);
                    }
                }
            };

            // Canvas Click
            document.getElementById('previewImage').onclick = handleCanvasClick;

            // Edit Fields
            document.getElementById('editLabelX').oninput = updateSelectedMarker;
            document.getElementById('editLabelY').oninput = updateSelectedMarker;

            // New Label Input Enter
            document.getElementById('newLabelInput').onkeypress = (e) => {
                if (e.key === 'Enter') addLabel();
            };
        }

        // --- Helper: Compress Image ---
        async function compressImage(file, maxWidth = 1600, quality = 0.6) {
            return new Promise((resolve) => {
                const url = URL.createObjectURL(file);
                const img = new Image();
                img.src = url;

                img.onload = () => {
                    URL.revokeObjectURL(url);
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > maxWidth) {
                            height = Math.round((height * maxWidth) / width);
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxWidth) {
                            width = Math.round((width * maxWidth) / height);
                            height = maxWidth;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    canvas.toBlob((blob) => {
                        if (!blob) {
                            resolve(file); // Fallback
                            return;
                        }
                        const compressedFile = new File([blob], file.name.replace(/\.[^/.]+$/, "") + ".jpg", { type: 'image/jpeg' });
                        resolve(compressedFile);
                    }, 'image/jpeg', quality);
                };

                img.onerror = () => {
                    URL.revokeObjectURL(url);
                    resolve(file); // Fallback to original if compression fails
                };
            });
        }

        // --- File Handling & Cloudinary ---
        async function handleFiles(files) {
            if (!files || files.length === 0) return;
            let file = files[0];
            if (!file.type.startsWith('image/')) return;

            const cloudName = document.getElementById('cloudName').value;
            const uploadPreset = document.getElementById('uploadPreset').value;
            const apiKey = document.getElementById('apiKey')?.value;
            const apiSecret = document.getElementById('apiSecret')?.value;

            if (!cloudName) {
                alert("Please enter Cloud Name.");
                return;
            }

            const statusEl = document.getElementById('uploadStatus');
            const statusText = statusEl.querySelector('p');
            statusEl.classList.remove('hidden');

            if (file.size > 1024 * 1024) {
                statusText.textContent = "Optimizing Image Size...";
                file = await compressImage(file);
            }

            statusText.textContent = "Uploading to Cloudinary...";

            const formData = new FormData();
            formData.append('file', file);

            if (apiKey && apiSecret) {
                const timestamp = Math.round((new Date()).getTime() / 1000);
                const signature = CryptoJS.SHA1(`timestamp=${timestamp}${apiSecret}`).toString();
                formData.append('api_key', apiKey);
                formData.append('timestamp', timestamp);
                formData.append('signature', signature);
            } else if (uploadPreset) {
                formData.append('upload_preset', uploadPreset);
            } else {
                alert("Please provide either (API Key + API Secret) OR an Unsigned Upload Preset.");
                document.getElementById('uploadStatus').classList.add('hidden');
                return;
            }

            try {
                const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (data.secure_url) {
                    imageUrl = data.secure_url;
                    displayImage(imageUrl);
                } else {
                    throw new Error(data.error?.message || "Upload failed");
                }
            } catch (err) {
                alert("Error: " + err.message);
            } finally {
                document.getElementById('uploadStatus').classList.add('hidden');
            }
        }

        function displayImage(url) {
            const img = document.getElementById('previewImage');
            img.src = url;
            img.onload = () => {
                // Ensure wrapper matches image size
                const wrapper = document.getElementById('imageWrapper');
                wrapper.style.width = img.clientWidth + 'px';
                wrapper.style.height = img.clientHeight + 'px';
                renderMarkers();
            };
            document.getElementById('dropzone').classList.add('hidden');
            document.getElementById('canvasContainer').classList.remove('hidden');
            document.getElementById('imageInfo').classList.remove('hidden');
            document.getElementById('cloudinaryUrlDisplay').textContent = url;
        }

        function changeImage() {
            if (!confirm("Are you sure? This will not clear your markers but will switch the image.")) return;
            document.getElementById('dropzone').classList.remove('hidden');
            document.getElementById('canvasContainer').classList.add('hidden');
            document.getElementById('imageInfo').classList.add('hidden');
        }

        // --- Label Management ---
        function addLabel() {
            const input = document.getElementById('newLabelInput');
            const name = input.value.trim();
            if (!name) return;
            const id = Date.now().toString();
            labels.push({ id, name });
            input.value = "";
            renderLabels();
            setActiveLabel(id);
        }

        function renderLabels() {
            const list = document.getElementById('labelList');
            document.getElementById('labelCount').textContent = labels.length;
            if (labels.length === 0) {
                list.innerHTML = `<p class="text-center py-8 text-slate-400 text-xs italic">No labels added yet</p>`;
                return;
            }
            list.innerHTML = labels.map(label => `
                <div class="group flex items-center justify-between p-3 rounded-xl border transition-all cursor-pointer ${activeLabelId === label.id ? 'bg-indigo-600 border-indigo-600 text-white shadow-lg' : 'bg-slate-50 border-slate-200 text-slate-700 hover:border-indigo-300'}" 
                     onclick="setActiveLabel('${label.id}')">
                    <span class="text-sm font-semibold truncate flex-1">${label.name}</span>
                    <button onclick="event.stopPropagation(); deleteLabel('${label.id}')" class="${activeLabelId === label.id ? 'text-indigo-200 hover:text-white' : 'text-slate-400 hover:text-red-500'} transition-colors ml-2">
                        <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                    </button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function setActiveLabel(id) {
            activeLabelId = id;
            selectedMarker = null;
            document.getElementById('markerSettings').classList.add('hidden');
            renderLabels();
        }

        function deleteLabel(id) {
            labels = labels.filter(l => l.id !== id);
            markers = markers.filter(m => labels.some(l => l.name === m.name));
            if (activeLabelId === id) activeLabelId = labels.length > 0 ? labels[0].id : null;
            renderLabels();
            renderMarkers();
        }

        // --- Marker Management ---
        function handleCanvasClick(e) {
            if (!activeLabelId) {
                alert("Please select a label first!");
                return;
            }
            const label = labels.find(l => l.id === activeLabelId);
            const rect = e.target.getBoundingClientRect();
            // Normalized 0.0 to 1.0 (YOLO style)
            const x = (e.clientX - rect.left) / rect.width;
            const y = (e.clientY - rect.top) / rect.height;

            markers.push({
                name: label.name,
                x: parseFloat(x.toFixed(6)),
                y: parseFloat(y.toFixed(6))
            });
            renderMarkers();
        }

        function renderMarkers() {
            const container = document.getElementById('markersLayer');
            container.innerHTML = markers.map((marker, idx) => `
                <div class="marker absolute w-6 h-6 border-2 border-white bg-indigo-600 rounded-full shadow-xl flex items-center justify-center pointer-events-auto cursor-pointer group"
                     style="left: ${marker.x * 100}%; top: ${marker.y * 100}%; transform: translate(-50%, -50%);"
                     onclick="event.stopPropagation(); selectMarker(${idx})">
                    <span class="text-[8px] font-bold text-white">${idx + 1}</span>
                    <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 bg-slate-900 text-white text-[10px] px-2 py-1 rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-all">
                        ${marker.name}
                    </div>
                </div>
            `).join('');
        }

        function selectMarker(index) {
            selectedMarker = index;
            const marker = markers[index];
            const settings = document.getElementById('markerSettings');
            settings.classList.remove('hidden');
            document.getElementById('editLabelName').textContent = marker.name;
            document.getElementById('editLabelX').value = marker.x;
            document.getElementById('editLabelY').value = marker.y;
        }

        function updateSelectedMarker() {
            if (selectedMarker === null) return;
            markers[selectedMarker].x = parseFloat(document.getElementById('editLabelX').value);
            markers[selectedMarker].y = parseFloat(document.getElementById('editLabelY').value);
            renderMarkers();
        }

        function deleteMarker() {
            if (selectedMarker === null) return;
            markers.splice(selectedMarker, 1);
            selectedMarker = null;
            document.getElementById('markerSettings').classList.add('hidden');
            renderMarkers();
        }

        // --- Export & Copy ---
        function exportToCSV() {
            if (markers.length === 0) return alert("Add markers first!");
            let csv = "image_url,label,x,y\n";
            markers.forEach(m => csv += `"${imageUrl}","${m.name}",${m.x},${m.y}\n`);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `yolo_labels_${Date.now()}.csv`;
            link.click();
        }

        function copyMockData() {
            const data = markers.map(m => `      { name: "${m.name}", x: ${m.x}, y: ${m.y} }`).join(',\n');
            const output = `    items: [\n${data}\n    ]`;
            navigator.clipboard.writeText(output).then(() => alert("Mock data items copied to clipboard!"));
        }

    </script>
</body>

</html>